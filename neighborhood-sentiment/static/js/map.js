$(function() {

  var map;
  var ajaxRequest;
  var plotlist;
  var plotlayers=[];
  var neighborhoodData = {"type": "FeatureCollection", "features": [{"geometry": {"type": "Polygon", "coordinates": [[[-73.922882, 40.85537099999999], [-73.915415, 40.863095], [-73.91206700000001, 40.86737900000001], [-73.910952, 40.869781], [-73.910522, 40.872182], [-73.91284, 40.87413], [-73.917475, 40.875363], [-73.92580000000001, 40.877504], [-73.928633, 40.876012], [-73.930435, 40.873934999999996], [-73.931723, 40.87166299999999], [-73.932152, 40.869067], [-73.928461, 40.86653600000001], [-73.92580000000001, 40.863615], [-73.923311, 40.859655000000004], [-73.922882, 40.85537099999999]]]}, "type": "Feature", "id": "0", "properties": {"name": "Inwood"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.973, 40.76429], [-73.958888, 40.758408], [-73.94837, 40.76903], [-73.94279, 40.775920000000006], [-73.94373000000002, 40.78281], [-73.95481, 40.787690000000005], [-73.94794, 40.79704], [-73.94923, 40.79763], [-73.973, 40.76429]]]}, "type": "Feature", "id": "1", "properties": {"name": "Upper East Side"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.93507000000001, 40.835567], [-73.931465, 40.84232000000001], [-73.923054, 40.85465599999999], [-73.923569, 40.859071], [-73.925371, 40.862836], [-73.928461, 40.866211], [-73.932323, 40.869002], [-73.938074, 40.858681], [-73.945799, 40.85024200000001], [-73.9464, 40.84212600000001], [-73.94846, 40.83823], [-73.949661, 40.836411], [-73.949661, 40.83446299999999], [-73.934984, 40.828164], [-73.93507000000001, 40.835567]]]}, "type": "Feature", "id": "2", "properties": {"name": "Washington Heights"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.934984, 40.81692700000001], [-73.949146, 40.79773], [-73.947816, 40.797047000000006], [-73.954597, 40.78775499999999], [-73.943696, 40.782979], [-73.93953300000001, 40.786066000000005], [-73.936787, 40.790290000000006], [-73.92992, 40.795228], [-73.929319, 40.798412], [-73.92992, 40.801660999999996], [-73.931036, 40.804065], [-73.933182, 40.806208000000005], [-73.934984, 40.809457], [-73.934727, 40.81303], [-73.934984, 40.81692700000001]]]}, "type": "Feature", "id": "3", "properties": {"name": "East Harlem"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.968973, 40.808352], [-73.981161, 40.79191399999999], [-73.993521, 40.77274200000001], [-73.981934, 40.767932], [-73.951464, 40.810139], [-73.954468, 40.811471], [-73.956699, 40.813939], [-73.961163, 40.818486], [-73.968973, 40.808352]]]}, "type": "Feature", "id": "4", "properties": {"name": "Upper West Side"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.949833, 40.834203], [-73.961163, 40.818843], [-73.956828, 40.814329], [-73.954511, 40.81173], [-73.952923, 40.810886], [-73.95112, 40.810301], [-73.958244, 40.800816], [-73.949833, 40.797015], [-73.934598, 40.817642], [-73.934813, 40.822741], [-73.935113, 40.828164], [-73.939061, 40.829755], [-73.942623, 40.831184], [-73.946228, 40.832645], [-73.949833, 40.834203]]]}, "type": "Feature", "id": "5", "properties": {"name": "Harlem"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.993607, 40.77261200000001], [-74.005108, 40.757075], [-73.993521, 40.752004], [-73.981891, 40.76780200000001], [-73.993607, 40.77261200000001]]]}, "type": "Feature", "id": "6", "properties": {"name": "Hell's Kitchen"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.991117, 40.755222], [-73.9885, 40.754052], [-73.98674, 40.75330399999999], [-73.98129, 40.761982999999994], [-73.98502300000001, 40.763446], [-73.991117, 40.755222]]]}, "type": "Feature", "id": "7", "properties": {"name": "Times Square"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.9782, 40.741437], [-73.972278, 40.74989], [-73.980989, 40.753499], [-73.986998, 40.745144], [-73.9782, 40.741437]]]}, "type": "Feature", "id": "8", "properties": {"name": "Murray Hill"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.967943, 40.748102], [-73.962235, 40.754734], [-73.971033, 40.758473], [-73.976054, 40.751613], [-73.967943, 40.748102]]]}, "type": "Feature", "id": "9", "properties": {"name": "Turtle Bay"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.975067, 40.735421], [-73.973093, 40.739226], [-73.98068900000001, 40.74238], [-73.983307, 40.738803], [-73.975067, 40.735421]]]}, "type": "Feature", "id": "10", "properties": {"name": "Kips Bay"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.002705, 40.739551], [-73.993607, 40.752036000000004], [-74.005151, 40.75691199999999], [-74.007339, 40.754019], [-74.008713, 40.750573], [-74.008842, 40.742281999999996], [-74.002705, 40.739551]]]}, "type": "Feature", "id": "11", "properties": {"name": "Chelsea"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.990388, 40.734543], [-73.9891, 40.736559], [-73.990474, 40.737015], [-73.991933, 40.735096000000006], [-73.990388, 40.734543]]]}, "type": "Feature", "id": "12", "properties": {"name": "Union Square"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.98262, 40.731259], [-73.988671, 40.72286799999999], [-73.978758, 40.719973], [-73.975368, 40.71889999999999], [-73.974166, 40.722933], [-73.97202, 40.726999], [-73.98262, 40.731259]]]}, "type": "Feature", "id": "13", "properties": {"name": "Alphabet City"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.988929, 40.722966], [-73.982878, 40.731291], [-73.989916, 40.734283], [-73.992491, 40.729633], [-73.996439, 40.72521], [-73.988929, 40.722966]]]}, "type": "Feature", "id": "14", "properties": {"name": "East Village"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.008927, 40.742185], [-74.010172, 40.739193], [-74.010859, 40.729113000000005], [-74.002919, 40.728429999999996], [-73.996825, 40.725275], [-73.992963, 40.729828], [-73.991461, 40.731909], [-73.99086, 40.734576000000004], [-74.008927, 40.742185]]]}, "type": "Feature", "id": "15", "properties": {"name": "Greenwich Village (West Village)"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.013262, 40.71821700000001], [-74.016824, 40.718575], [-74.019399, 40.706897], [-74.019442, 40.705303], [-74.018497, 40.704066], [-74.016824, 40.704684], [-74.012918, 40.71724100000001], [-74.013262, 40.71821700000001]]]}, "type": "Feature", "id": "16", "properties": {"name": "Battery Park City"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.005065, 40.70688], [-74.003799, 40.705612], [-73.999786, 40.70797], [-74.001803, 40.709564], [-74.005065, 40.70688]]]}, "type": "Feature", "id": "17", "properties": {"name": "South Street Seaport"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.994122, 40.720395999999994], [-73.99734, 40.72156699999999], [-74.000087, 40.71815200000001], [-73.999271, 40.71750099999999], [-74.000731, 40.715517], [-74.00043, 40.71431400000001], [-73.998456, 40.71324], [-74.001117, 40.71002000000001], [-73.999057, 40.708328], [-73.980346, 40.710996], [-73.9779, 40.712004], [-73.977342, 40.713208], [-73.97644, 40.714997], [-73.994122, 40.720395999999994]]]}, "type": "Feature", "id": "18", "properties": {"name": "Chinatown"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.9955522, 40.7250247], [-73.995752, 40.724722], [-73.995924, 40.724755], [-73.997426, 40.721632], [-73.976269, 40.715127], [-73.974981, 40.71864], [-73.9955522, 40.7250247]]]}, "type": "Feature", "id": "19", "properties": {"name": "Lower East Side"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.011159, 40.72612], [-74.01283300000001, 40.717175999999995], [-74.00631, 40.714086], [-74.001932, 40.71942], [-74.011159, 40.72612]]]}, "type": "Feature", "id": "20", "properties": {"name": "TriBeCa"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.015365, 40.70849100000001], [-74.01742500000002, 40.704099], [-74.01648, 40.702179], [-74.01515, 40.70136600000001], [-74.013391, 40.700976000000004], [-74.010816, 40.701821], [-74.008455, 40.702667000000005], [-74.00382, 40.7054], [-74.00536, 40.7067], [-74.00442, 40.7079], [-74.00631, 40.709889999999994], [-74.00811200000001, 40.712102], [-74.013519, 40.714379], [-74.015365, 40.70849100000001]]]}, "type": "Feature", "id": "21", "properties": {"name": "Wall Street"}}]};
  var layer = null;

  function updateSentimentData(neighborhood_sentiments) {
    neighborhood_sentiments.forEach(function(neighborhood_sentiment, index, array) {
      neighborhoodData.features.forEach(function(feature, feature_index, array) {
        if (feature.properties.name == neighborhood_sentiment.neighborhood) {
          //alert('neighborhood: '+JSON.stringify(neighborhood_sentiment.neighborhood)+", feature_index: "+JSON.stringify(feature_index));
          neighborhoodData.features[feature_index].properties.sentiment = neighborhood_sentiment.sentiment;
        }
      });
    });
  };

  function getColor(sentiment) {
    var color = '';
    if (sentiment >= .6) {
      // green
      color = '#1a9641';
    } else if (sentiment >= .2) {
      color = '#a6d96a';
    } else if (sentiment >= -.2) {
      // yellow
      color = '#ffffbf';
    } else if (sentiment >= -.6) {
      color = '#fdae61';
    } else if (sentiment >= -1) {
      // red
      color = '#d7191c';
    }

    return color;
  };

  function style(feature) {
    return {
        fillColor: getColor(feature.properties.sentiment),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
    };
  };

  function initmap() {
    // set up the map
    map = new L.Map('mapid');

    // create the tile layer with correct attribution
    var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
    var osm = new L.TileLayer(osmUrl, {
      minZoom: 8,
      maxZoom: 12,
      attribution: osmAttrib
    });
    /*
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + mapboxAccessToken, {
        id: 'mapbox.light',
        attribution: ...
    }).addTo(map);
    */

    var neighborhoodData = {"type": "FeatureCollection", "features": [{"geometry": {"type": "Polygon", "coordinates": [[[-73.922882, 40.85537099999999], [-73.915415, 40.863095], [-73.91206700000001, 40.86737900000001], [-73.910952, 40.869781], [-73.910522, 40.872182], [-73.91284, 40.87413], [-73.917475, 40.875363], [-73.92580000000001, 40.877504], [-73.928633, 40.876012], [-73.930435, 40.873934999999996], [-73.931723, 40.87166299999999], [-73.932152, 40.869067], [-73.928461, 40.86653600000001], [-73.92580000000001, 40.863615], [-73.923311, 40.859655000000004], [-73.922882, 40.85537099999999]]]}, "type": "Feature", "id": "0", "properties": {"name": "Inwood"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.973, 40.76429], [-73.958888, 40.758408], [-73.94837, 40.76903], [-73.94279, 40.775920000000006], [-73.94373000000002, 40.78281], [-73.95481, 40.787690000000005], [-73.94794, 40.79704], [-73.94923, 40.79763], [-73.973, 40.76429]]]}, "type": "Feature", "id": "1", "properties": {"name": "Upper East Side"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.93507000000001, 40.835567], [-73.931465, 40.84232000000001], [-73.923054, 40.85465599999999], [-73.923569, 40.859071], [-73.925371, 40.862836], [-73.928461, 40.866211], [-73.932323, 40.869002], [-73.938074, 40.858681], [-73.945799, 40.85024200000001], [-73.9464, 40.84212600000001], [-73.94846, 40.83823], [-73.949661, 40.836411], [-73.949661, 40.83446299999999], [-73.934984, 40.828164], [-73.93507000000001, 40.835567]]]}, "type": "Feature", "id": "2", "properties": {"name": "Washington Heights"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.934984, 40.81692700000001], [-73.949146, 40.79773], [-73.947816, 40.797047000000006], [-73.954597, 40.78775499999999], [-73.943696, 40.782979], [-73.93953300000001, 40.786066000000005], [-73.936787, 40.790290000000006], [-73.92992, 40.795228], [-73.929319, 40.798412], [-73.92992, 40.801660999999996], [-73.931036, 40.804065], [-73.933182, 40.806208000000005], [-73.934984, 40.809457], [-73.934727, 40.81303], [-73.934984, 40.81692700000001]]]}, "type": "Feature", "id": "3", "properties": {"name": "East Harlem"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.968973, 40.808352], [-73.981161, 40.79191399999999], [-73.993521, 40.77274200000001], [-73.981934, 40.767932], [-73.951464, 40.810139], [-73.954468, 40.811471], [-73.956699, 40.813939], [-73.961163, 40.818486], [-73.968973, 40.808352]]]}, "type": "Feature", "id": "4", "properties": {"name": "Upper West Side"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.949833, 40.834203], [-73.961163, 40.818843], [-73.956828, 40.814329], [-73.954511, 40.81173], [-73.952923, 40.810886], [-73.95112, 40.810301], [-73.958244, 40.800816], [-73.949833, 40.797015], [-73.934598, 40.817642], [-73.934813, 40.822741], [-73.935113, 40.828164], [-73.939061, 40.829755], [-73.942623, 40.831184], [-73.946228, 40.832645], [-73.949833, 40.834203]]]}, "type": "Feature", "id": "5", "properties": {"name": "Harlem"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.993607, 40.77261200000001], [-74.005108, 40.757075], [-73.993521, 40.752004], [-73.981891, 40.76780200000001], [-73.993607, 40.77261200000001]]]}, "type": "Feature", "id": "6", "properties": {"name": "Hell's Kitchen"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.991117, 40.755222], [-73.9885, 40.754052], [-73.98674, 40.75330399999999], [-73.98129, 40.761982999999994], [-73.98502300000001, 40.763446], [-73.991117, 40.755222]]]}, "type": "Feature", "id": "7", "properties": {"name": "Times Square"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.9782, 40.741437], [-73.972278, 40.74989], [-73.980989, 40.753499], [-73.986998, 40.745144], [-73.9782, 40.741437]]]}, "type": "Feature", "id": "8", "properties": {"name": "Murray Hill"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.967943, 40.748102], [-73.962235, 40.754734], [-73.971033, 40.758473], [-73.976054, 40.751613], [-73.967943, 40.748102]]]}, "type": "Feature", "id": "9", "properties": {"name": "Turtle Bay"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.975067, 40.735421], [-73.973093, 40.739226], [-73.98068900000001, 40.74238], [-73.983307, 40.738803], [-73.975067, 40.735421]]]}, "type": "Feature", "id": "10", "properties": {"name": "Kips Bay"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.002705, 40.739551], [-73.993607, 40.752036000000004], [-74.005151, 40.75691199999999], [-74.007339, 40.754019], [-74.008713, 40.750573], [-74.008842, 40.742281999999996], [-74.002705, 40.739551]]]}, "type": "Feature", "id": "11", "properties": {"name": "Chelsea"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.990388, 40.734543], [-73.9891, 40.736559], [-73.990474, 40.737015], [-73.991933, 40.735096000000006], [-73.990388, 40.734543]]]}, "type": "Feature", "id": "12", "properties": {"name": "Union Square"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.98262, 40.731259], [-73.988671, 40.72286799999999], [-73.978758, 40.719973], [-73.975368, 40.71889999999999], [-73.974166, 40.722933], [-73.97202, 40.726999], [-73.98262, 40.731259]]]}, "type": "Feature", "id": "13", "properties": {"name": "Alphabet City"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.988929, 40.722966], [-73.982878, 40.731291], [-73.989916, 40.734283], [-73.992491, 40.729633], [-73.996439, 40.72521], [-73.988929, 40.722966]]]}, "type": "Feature", "id": "14", "properties": {"name": "East Village"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.008927, 40.742185], [-74.010172, 40.739193], [-74.010859, 40.729113000000005], [-74.002919, 40.728429999999996], [-73.996825, 40.725275], [-73.992963, 40.729828], [-73.991461, 40.731909], [-73.99086, 40.734576000000004], [-74.008927, 40.742185]]]}, "type": "Feature", "id": "15", "properties": {"name": "Greenwich Village (West Village)"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.013262, 40.71821700000001], [-74.016824, 40.718575], [-74.019399, 40.706897], [-74.019442, 40.705303], [-74.018497, 40.704066], [-74.016824, 40.704684], [-74.012918, 40.71724100000001], [-74.013262, 40.71821700000001]]]}, "type": "Feature", "id": "16", "properties": {"name": "Battery Park City"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.005065, 40.70688], [-74.003799, 40.705612], [-73.999786, 40.70797], [-74.001803, 40.709564], [-74.005065, 40.70688]]]}, "type": "Feature", "id": "17", "properties": {"name": "South Street Seaport"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.994122, 40.720395999999994], [-73.99734, 40.72156699999999], [-74.000087, 40.71815200000001], [-73.999271, 40.71750099999999], [-74.000731, 40.715517], [-74.00043, 40.71431400000001], [-73.998456, 40.71324], [-74.001117, 40.71002000000001], [-73.999057, 40.708328], [-73.980346, 40.710996], [-73.9779, 40.712004], [-73.977342, 40.713208], [-73.97644, 40.714997], [-73.994122, 40.720395999999994]]]}, "type": "Feature", "id": "18", "properties": {"name": "Chinatown"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-73.9955522, 40.7250247], [-73.995752, 40.724722], [-73.995924, 40.724755], [-73.997426, 40.721632], [-73.976269, 40.715127], [-73.974981, 40.71864], [-73.9955522, 40.7250247]]]}, "type": "Feature", "id": "19", "properties": {"name": "Lower East Side"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.011159, 40.72612], [-74.01283300000001, 40.717175999999995], [-74.00631, 40.714086], [-74.001932, 40.71942], [-74.011159, 40.72612]]]}, "type": "Feature", "id": "20", "properties": {"name": "TriBeCa"}}, {"geometry": {"type": "Polygon", "coordinates": [[[-74.015365, 40.70849100000001], [-74.01742500000002, 40.704099], [-74.01648, 40.702179], [-74.01515, 40.70136600000001], [-74.013391, 40.700976000000004], [-74.010816, 40.701821], [-74.008455, 40.702667000000005], [-74.00382, 40.7054], [-74.00536, 40.7067], [-74.00442, 40.7079], [-74.00631, 40.709889999999994], [-74.00811200000001, 40.712102], [-74.013519, 40.714379], [-74.015365, 40.70849100000001]]]}, "type": "Feature", "id": "21", "properties": {"name": "Wall Street"}}]};

    // start the map in NYC
    map.setView(new L.LatLng(40.787472, -73.962655), 11);
    map.addLayer(osm);

    layer = L.geoJson(neighborhoodData, {style: style});
    layer.addTo(map);

    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend');
      var sentiments = [-1, -.6, -.2, .2, .6, 1];
      var labels = [];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < sentiments.length - 1; i++) {
        var label = '';
        if (i == 0) {
          label = 'Negative';
        } else if (i == sentiments.length - 2) {
          label = 'Positive';
        } else if (i == (sentiments.length / 2) - 1) {
          label = 'Neutral';
        }
        div.innerHTML +=
          '<i style="background:' + getColor(sentiments[i]) + '"></i> ' +
          label + '<br>';
      }

      return div;
    };

    legend.addTo(map);
  };

  initmap();

  setInterval(function() {
    $.get("/sentiments", function(data) {
      neighborhood_sentiments = JSON.parse(data);
      updateSentimentData(neighborhood_sentiments);
      layer.clearLayers();
      layer.addData(neighborhoodData);
    });
    // updateSentimentData([
    //   {
    //     neighborhood: 'Wall Street',
    //     sentiment: '-.7'
    //   }
    // ]);
    // layer.clearLayers();
    // //alert("Wall Street Sentiment: "+JSON.stringify(neighborhoodData.features[21].properties.sentiment));
    // layer.addData(neighborhoodData);
    // //alert('layer change?');
  }, 3000); // every 3 seconds

});
